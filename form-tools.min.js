/**
 * Created by artroot on 18.06.17.
 */

!function(formTools,undefined){function getElementsByAttr(t,e,n,o){var i=(t||document).querySelectorAll((o||"*")+"["+e+(n?'="'+n+'"]':"]"));return i.length>1?i:i[0]}function isset(t,e,n){if(t)return t;if(n)return n();throw new Error(e)}function isObject(t,e,n){if("object"!=typeof t){if(n)return n();throw new Error(e)}return t}function isEmpty(t,e,n){if(t.length<1){if(n)return n();throw new Error(e)}return t}function init(t,e){var n=getElementsByAttr(document,t);if(n)if(n&&!n.tagName&&"length"in n&&n.length>1)for(var o=0;o<=n.length;o++)e(n[o]);else e(n)}formTools.inits={};var FT=formTools,consts={cp:{init:"cp-init",options:"cp-options",template:"cp-template",viewport:"cp-viewport",add:"cp-add",rm:"cp-rm",counter:"cp-counter",inputs:"cp-inputs"},setNulls:{init:"set-nulls"}};FT.discovery=function(){return init(consts.cp.init,function(t){var e=!!t&&t.getAttribute(consts.cp.init).valueOf();e&&(FT.inits[e]=new FT.clonePattern(t,t.getAttribute(consts.cp.options)))}),init(consts.setNulls.init,function(t){t&&(t.onchange=function(){FT.setNulls(t)},FT.setNulls(t))}),FT},FT.clonePattern=function(root,options){var self=this,initName,timeout,interval;this.options=options&&options.length>0?eval("("+options+")"):{};try{isObject(root,"Initialization area not found.");var initName=isEmpty(root.getAttribute(consts.cp.init),consts.cp.init+" ID not specified."),viewport=isObject(getElementsByAttr(root,consts.cp.viewport),null,function(){return isObject(getElementsByAttr(document,consts.cp.viewport,initName),consts.cp.viewport+" is not marked")}),template=isObject(getElementsByAttr(viewport,consts.cp.template),consts.cp.template+" is not marked"),addBtn=isObject(getElementsByAttr(root,consts.cp.add),null,function(){return isObject(getElementsByAttr(document,consts.cp.add,initName),consts.cp.add+" button is not marked")}),inputs=isObject(getElementsByAttr(template,consts.cp.inputs),consts.cp.inputs+" is not marked"),setDelyEvents={onmousedown:function(){self.options.massAdd&&(self.timeout=setTimeout(function(){self.interval=setInterval(function(){for(var t=1;t<=self.options.massAdd&&0!=self.addNode();t++);},1e3)},500))},onmouseup:function(){clearTimeout(self.timeout),self.interval?(clearInterval(self.interval),self.interval=null):self.addNode()},onmouseleave:function(){clearTimeout(self.timeout),self.interval&&(clearInterval(self.interval),self.interval=null)}};if(isObject(addBtn,null,function(){return!1}))for(var event in setDelyEvents)addBtn[event]=setDelyEvents[event];var rmBtnTemplate=isset(getElementsByAttr(template,consts.cp.rm),null,function(){});isObject(rmBtnTemplate,null,function(){return!1})&&(rmBtnTemplate.onclick=function(){self.rmNode(getElementsByAttr(root,consts.cp.template))}),template=template.cloneNode(!0)}catch(t){return void console.error(t.message)}this.addNode=function(t){var e=this;if(this.options.maxNode&&viewport.childElementCount>=this.options.maxNode)return alert(this.options.maxNodeMsg?this.options.maxNodeMsg:"Max. nodes not more "+this.options.maxNode),!1;var n=template.cloneNode(!0),o=getElementsByAttr(n,consts.cp.counter);o&&(o.innerHTML=viewport.childElementCount+1);var i=getElementsByAttr(n,consts.cp.rm);"object"==typeof i&&(i.onclick=function(){e.rmNode(n)});try{var s=isObject(getElementsByAttr(n,consts.cp.inputs),consts.cp.inputs+" is not marked");if("object"==typeof t&&"object"==typeof s){var r=0;(s=s.querySelectorAll("*[name]")).forEach(function(e){if(void 0!==e&&e.name){switch(e.tagName){case"INPUT":e.value=t[r]?t[r]:null;break;case"SELECT":getElementsByAttr(e,"value",t[r]?t[r]:null,"option").selected=!0;break;default:e.innerHTML=t[r]?t[r]:null}r++}})}}catch(t){console.warn(t.message)}return n.removeAttribute(consts.cp.template),viewport.appendChild(n),this};var rebuildNodes=function(){var t=1;viewport.childNodes.forEach(function(e){if(e.tagName){var n=getElementsByAttr(e,consts.cp.counter);n&&(n.innerHTML=t++)}})};if(this.rmNode=function(t){if(this.options.minNode&&viewport.childElementCount<=this.options.minNode)return alert(this.options.minNodeMsg?this.options.minNodeMsg:"Min. nodes not less "+this.options.minNode),this;t.remove(),rebuildNodes()},this.flushViewport=function(t){try{for(var e=isObject(getElementsByAttr(t,consts.cp.viewport),consts.cp.viewport+" is not marked");e.childNodes[0];)e.removeChild(e.childNodes[0]);return this}catch(t){return void console.error(t.message)}},this.options.startNode&&this.options.startNode>1)for(var startNode=1;startNode<this.options.startNode;startNode++)this.addNode();return this},FT.pushData=function(t,e){try{var n=isObject(getElementsByAttr(document,consts.cp.init,t),t+" not found");return FT.inits[t]=new this.clonePattern(n,n.getAttribute(consts.cp.options)),FT.inits[t].flushViewport(n),e.length>0&&e.forEach(function(e){FT.inits[t].addNode(e)}),this}catch(t){return void console.error(t)}},FT.setNulls=function(t){t.value&&""!=t.value&&(t.value.indexOf(".")<0?t.value=t.value+".00":null==t.value.match("[0-9]+.+[0-9]")?t.value=t.value+"00":null==t.value.match("[0-9]+.+[0-9]{2}")&&(t.value=t.value+"0"))},window.onload=function(){if(!Object.prototype.forEach&&!Element.prototype.remove&&void 0===window.jQuery)throw new Error("formTools JavaScript requires jQuery");FT.discovery()}}(window.formTools=window.formTools||{});
